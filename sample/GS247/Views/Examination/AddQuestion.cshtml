@model dynamic
@{
    Layout = "~/Views/Shared/_ExaminationLayout.cshtml";
}

<style>
    .aq-row {
        width: 100%;
        display: inline-block;
    }

    .multi_addBlock {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: start;
        -ms-flex-align: start;
        align-items: flex-start;
        align-items: center;
        width: 100%;
    }

    .multi_List_addBlock {
        margin: 10px 4px;
    }

    .col-md-12 {
        padding-left: unset;
    }

    .err_msg {
        color: red;
    }

    .right {
        background-color: #6bca20 !important;
        color: #fff !important;
        text-align: center !important;
    }

    .main-nm-bg {
        cursor: pointer;
        height: 26px;
        width: 21px;
        line-height: 18px;
        text-align: center;
        font-weight: 600;
        display: block;
        padding: 5px !important;
        font-size: 14px !important;
    }
</style>

<div class="cont_right formWrapper">
    <h1>Add Questions for Exam - @ViewBag.Name</h1>

    <div class="button-bg">
        <div class="top-hed-btn-left">
            <a class="a_tag-btn" href="@Url.Action("OnlineExams", "Examination")"><span>Back</span></a>
        </div>
        <div class="top-hed-btn-right">
           
        </div>
    </div>

    <div class="form-group">
        <p class="note">Fields with <span class="required">*</span>are required.</p>
        <div style="display:none"><input type="hidden" value="@ViewBag.ExamId" name="ExamId" /></div>
        <div class="aq-row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="QuestionName">Question <span class="required">*</span></label>
                    <textarea class="form-control" name="QuestionName" id="QuestionName" style="height:150px" required></textarea>
                </div>
            </div>
        </div>

        <div class="aq-row">
            <div class="col-md-12">
                <div class="yellow-bg yellow-bg-cnt">
                    <div class="aq-row">
                        <div class="col-md-12">
                            <div class="">
                                <div class="form-group custom-radioBtn" id="RadioButtonList">
                                    <h3> <label for="OnlineExamQuestions_question_type_1" class="required">Question Type <span class="required">*</span></label></h3>
                                    <input class="qp_custom-type" id="OnlineExamQuestions_question_type_0" value="1" type="radio" name="OnlineExamQuestions[question_type]" />
                                    <label style="" class="qp_type" for="OnlineExamQuestions_question_type_1">Multi choice</label>
                                    <input class="qp_custom-type" id="OnlineExamQuestions_question_type_1" value="2" type="radio" name="OnlineExamQuestions[question_type]" />
                                    <label style="" class="qp_type" for="OnlineExamQuestions_question_type_1">True/False</label>
                                    <input class="qp_custom-type" id="OnlineExamQuestions_question_type_2" value="3" type="radio" name="OnlineExamQuestions[question_type]" />
                                    <label style="" class="qp_type" for="OnlineExamQuestions_question_type_2">Short Answer</label>
                                    <input class="qp_custom-type" id="OnlineExamQuestions_question_type_3" value="4" type="radio" name="OnlineExamQuestions[question_type]" />
                                    <label style="" class="qp_type" for="OnlineExamQuestions_question_type_3">Multi Line</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="aq-row" style="display: none;" id="multi-row">
                    <div class="aq-row">
                        <div class="col-md-12">
                            <div class="mark-bg-inner">
                                <div class="aq-row">
                                    <div class="col-md-12">
                                        <div class="Question-block">
                                            <h3>Options</h3>
                                        </div>
                                    </div>
                                    <div class="question-m-blk">
                                        <div class="form-group">
                                            <div id="choices">

                                                <div class="choice-data" id="choice-data-0" data-row="0">
                                                    <div class="Question-block multi_addBlock">
                                                        <div class="multi_List_addBlock">
                                                            <label class="main number main-nm-bg cmd-bg" data="0">A</label>
                                                        </div>
                                                        <div class="multi_List_addBlock">
                                                            <input placeholder="Option Value" class="form-control for multi-choice choice-value" style="" name="OnlineExamQuestions[choice_answer][0]" id="OnlineExamQuestions_choice_answer_0" type="text" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="choice-data" id="choice-data-1" data-row="1">
                                                    <div class="Question-block multi_addBlock">
                                                        <div class="multi_List_addBlock">
                                                            <label class="main number main-nm-bg cmd-bg" data="1">B</label>
                                                        </div>
                                                        <div class="multi_List_addBlock">
                                                            <input placeholder="Option Value" class="form-control for multi-choice choice-value" style="" name="OnlineExamQuestions[choice_answer][1]" id="OnlineExamQuestions_choice_answer_1" type="text" />
                                                        </div>

                                                    </div>
                                                </div>

                                                <div class="choice-data" id="choice-data-1" data-row="2">
                                                    <div class="Question-block multi_addBlock">
                                                        <div class="multi_List_addBlock">
                                                            <label class="main number main-nm-bg cmd-bg" data="1">C</label>
                                                        </div>
                                                        <div class="multi_List_addBlock">
                                                            <input placeholder="Option Value" class="form-control for multi-choice choice-value" style="" name="OnlineExamQuestions[choice_answer][1]" id="OnlineExamQuestions_choice_answer_1" type="text" />
                                                        </div>

                                                    </div>
                                                </div>

                                                <div class="choice-data" id="choice-data-1" data-row="3">
                                                    <div class="Question-block multi_addBlock">
                                                        <div class="multi_List_addBlock">
                                                            <label class="main number main-nm-bg cmd-bg" data="1">D</label>
                                                        </div>
                                                        <div class="multi_List_addBlock">
                                                            <input placeholder="Option Value" class="form-control for multi-choice choice-value" style="" name="OnlineExamQuestions[choice_answer][1]" id="OnlineExamQuestions_choice_answer_1" type="text" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="err_msg" style="padding-left: 47px;" id="options_error"></div>
                                            <div class="err_msg" id="choice_answer_error"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="aq-row" style="display: none;" id="type-row">
                    <div class="aq-row">
                        <div class="col-md-12">
                            <div class="mark-bg-inner">
                                <div class="aq-row">
                                    <div class="col-md-12">
                                        <div class="form-group online-q-aType" id="RadioButtonType">
                                            <h3>Answer *</h3>
                                            <input id="ytOnlineExamQuestions_type_answer" type="hidden" value="" name="OnlineExamQuestions[type_answer]" />
                                            <input id="OnlineExamQuestions_type_answer_0" value="1" type="radio" name="OnlineExamQuestions[type_answer]" />
                                            <label style="" for="OnlineExamQuestions_type_answer_0">True</label>
                                            <input id="OnlineExamQuestions_type_answer_1" value="0" type="radio" name="OnlineExamQuestions[type_answer]" />
                                            <label style="" for="OnlineExamQuestions_type_answer_1">False</label>
                                            <div class="err_msg" id="type_answer_error"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="aq-row" style="display: none;" id="multi-line-row">
                    <div class="aq-row">
                        <div class="col-md-12">
                            <div class="mark-bg-inner">
                                <div class="aq-row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <h3> <label for="OnlineExamQuestions_exam_answer">Answer</label> *</h3>
                                            <textarea class="form-control" name="OnlineExamQuestions[exam_answer]" style="height:150px;" id="OnlineExamQuestions_exam_answer"></textarea>                                <div class="err_msg" id="text_answer_error"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="aq-row">
                    <div class="col-md-12">
                        <div class="mark-bg-inner">
                            <label for="Mark">Mark</label><span style="color:red"> *</span>
                            <input class="form-control" style="width:150px" name="Mark" id="Mark" type="text" />                
                            <br />
                            <label style="display:none" id="lbl"><span class="required" id="span"></span></label>
                        </div>
                    </div>
                </div>
                
            </div>

            <div class="txtfld-col-btn btn-top">
                <div class="txtfld-col-btn-block">
                    <div class="buttons">
                        <input class="formbut-n" id="save_btn" data="0" name="yt0" type="button" value="Save" />
                        <input class="formbut-n" id="save_btns" data="1" name="yt1" type="button" value="Save and add another" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

        $('#RadioButtonType input[type="hidden"][name="OnlineExamQuestions[type_answer]"]').attr('disabled', true);
        $('#RadioButtonAnswer input[type="hidden"][name="OnlineExamQuestions[choice_answer_id]"]').attr('disabled', true);
        $('#RadioButtonList input[type="hidden"][name="OnlineExamQuestions[question_type]"]').attr('disabled', true);
        $('#RadioButtonList input[name="OnlineExamQuestions[question_type]"]').change(function () {
            $('.err_msg').hide().text('');
            examFormval();
            var $val = $(this).val();
            switch ($val) {
                case '1':
                    $('#multi-row').slideDown('slow');
                    $('#multi-row-answer').slideDown('slow');
                    break;
                case '2':
                    $('#type-row').slideDown('slow');
                    break;
                case '3':
                    $('#multi-line-row').slideDown('slow');
                    break;
                case '4':
                    $('#multi-line-row').slideDown('slow');
                    break;
            }
        });

        $('#save_btn,#save_btns').click(function (e) {
            $('#span').html('');
            $('#lbl').css('display', 'none');
            e.preventDefault();           
            $('.err_msg').hide().text('');
            var submit_type = $(this).attr('data');
            createnew_question(submit_type);
        });

        function examFormval() {
            $('#multi-row').slideUp('slow');
            $('#multi-row-answer').slideUp('slow');
            $('#type-row').slideUp('slow');
            $('#multi-line-row').slideUp('slow');
        }

        function createnew_question(submit_type) {
            var error_flag = 0;
            var questionName = $('#QuestionName').val();
            var question_type = $('#RadioButtonList input[type="radio"][name="OnlineExamQuestions[question_type]"]:checked').val();
            var type_answer = $('#RadioButtonType input[type="radio"][name="OnlineExamQuestions[type_answer]"]:checked').val();
            var mark = $('#Mark').val();
            var right_choice =  $('#choices label.right').closest('.Question-block').find('div input').val();            
            if (questionName == null || questionName == "") {
                $('#QuestionName').css("border", "1px solid red");
                return false;
            }

            if (question_type == null || question_type == undefined) {
                $('#RadioButtonList').css("border", "1px solid red");
                return false;
            }

            if (mark == null || mark == "") {
                $('#Mark').css("border", "1px solid red");
                return false;
            }

            if ((isNaN(mark)) || !parseInt(mark) || mark <= 0) {
                $('#Mark').css("border", "1px solid red");
                return false;
            }

            if (parseFloat(mark) > 100) {
                $('#Mark').css("border", "1px solid red");
                return false;
            }

            if (question_type) {
                if (question_type == 1) {
                    var $option_err = 0;
                    $("input[type='text'].multi-choice").each(function (index, element) {
                        var that = this;
                        $(that).removeClass('option_error');
                        var option = $(that).val();
                        if (option == '' || ($.trim(option)).length == 0) {
                            error_flag = 1;
                            $option_err = 1;
                            val_error('Options cannot be blank', 'options_error');
                        }
                    });

                    if ($option_err == 0 && right_choice.length == '0') {
                        error_flag = 1;
                        val_error('Select correct answer', 'choice_answer_error');
                    }
                }
                if (question_type == 2) {
                    if (typeof type_answer == 'undefined') {
                        val_error('Answer cannot be blank', 'type_answer_error');
                        error_flag = 1;
                    }
                }
                if (question_type == 3 || question_type == 4) {
                    if (mark == null || mark == "") {
                        $('#OnlineExamQuestions_exam_answer').css("border", "1px solid red");
                        return false;
                    }
                }
            }

            if(error_flag == 1)
                return false;

            var QuestionPaper = new Object();
            QuestionPaper.QuestionName = questionName;
            QuestionPaper.QuestionType = parseInt(question_type);
            QuestionPaper.Mark = parseFloat(mark);
            QuestionPaper.ExamId = @ViewBag.ExamId;

            if(question_type == 1)
            {
                var optionlist=[];
                $("input[type='text'].multi-choice").each(function (index, element) {
                    var that = this;
                    var option = $(that).val();
                    optionlist.push(option);
                });

                QuestionPaper.OptionValue = optionlist;
                QuestionPaper.Answer = right_choice;
            }
            else  if(question_type == 2)
            {
                QuestionPaper.Answer = type_answer;
            }
            else  if(question_type == 3 || question_type == 4 )
            {
                QuestionPaper.Answer = $('#OnlineExamQuestions_exam_answer').val();
            }

            var d = { questionPaper: QuestionPaper };

            $.ajax({
                type: "POST",
                url: "/Examination/AddQuestion",
                data: JSON.stringify(d),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if(response.Message != "")
                    {
                        $('#span').html(response.Message);
                        $('#lbl').css('display', 'block');
                    }
                    else
                    {  
                        $('#span').html('');
                        $('#lbl').css('display', 'none');
                        if(submit_type == "1")
                            location.reload(true);
                        else
                        {
                            if(response.Type == 1)
                                window.location.href = '/Examination/OnlineExams';
                            else
                                window.location.href = '/Examination/CommonExams';
                        }                            
                    }                   
                },
                error: function () {
                    location.reload(true);
                }
            });
        }
        function val_error(msg, id) {
            $('#' + id).text(msg).show();
            window.setTimeout(function () { $('.err_msg').hide().text(''); }, 30000);
        }

        function set_events() {
            $('.choice-data .Question-block .number').unbind('click');
            $(".choice-data .Question-block .number").click(function () {
                $(this).parent().parent().parent().parent().find('.number').removeClass('right');
                $(this).addClass('right');

            });
        }
        set_events();
</script>


